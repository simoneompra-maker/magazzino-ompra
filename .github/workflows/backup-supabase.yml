name: Supabase Backup

on:
  schedule:
    # Ogni 12 ore (mezzanotte e mezzogiorno UTC)
    - cron: "0 0,12 * * *"
  # Permette di lanciarlo manualmente dalla tab Actions
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Installa client PostgreSQL 17
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq wget ca-certificates lsb-release > /dev/null 2>&1
          wget -qO - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add - 2>/dev/null
          echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list > /dev/null
          sudo apt-get update -qq
          sudo apt-get install -y -qq postgresql-client-17 > /dev/null 2>&1

      - name: Backup database
        env:
          DATABASE_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          mkdir -p backups
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          
          # Dump completo (schema + dati)
          /usr/lib/postgresql/17/bin/pg_dump "$DATABASE_URL" \
            --format=plain \
            --no-owner \
            --no-privileges \
            --clean \
            --if-exists \
            > backups/ompra_backup_${TIMESTAMP}.sql
          
          # Tieni solo gli ultimi 30 backup (elimina i piÃ¹ vecchi)
          cd backups
          ls -t ompra_backup_*.sql | tail -n +31 | xargs -r rm --
          cd ..
          
          echo "âœ… Backup completato: ompra_backup_${TIMESTAMP}.sql"
          echo "ğŸ“¦ Dimensione: $(du -h backups/ompra_backup_${TIMESTAMP}.sql | cut -f1)"
          echo "ğŸ“ Backup totali: $(ls backups/ompra_backup_*.sql | wc -l)"

      - name: Commit e push backup
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ”„ Supabase backup automatico"
          file_pattern: "backups/*.sql"
          branch: main
